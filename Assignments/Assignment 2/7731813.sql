-- DROP TABLE REP;
-- DROP TABLE CUSTOMER;
-- DROP TABLE ORDERS;
-- DROP TABLE PART;
-- DROP TABLE ORDER_LINE;
-- DROP DOMAIN CLASSES;

CREATE DOMAIN CLASSES AS CHAR(2) NOT NULL
CHECK(
   VALUE = 'AP' OR VALUE = 'HW' OR VALUE = 'SG'
);

CREATE TABLE REP (
  REP_NUM    CHAR(2) PRIMARY KEY,
  LAST_NAME  CHAR(15),
  FIRST_NAME CHAR(15),
  STREET     CHAR(15),
  CITY       CHAR(15),
  STATE      CHAR(3),
  ZIP        CHAR(5),
  COMMISSION DECIMAL(7, 2),
  RATE       DECIMAL(3, 2)
);

CREATE TABLE CUSTOMER (
  CUSTOMER_NUM  CHAR(3) PRIMARY KEY,
  CUSTOMER_NAME CHAR(35) NOT NULL,
  STREET        CHAR(15),
  CITY          CHAR(15),
  STATE         CHAR(3),
  ZIP           CHAR(5),
  BALANCE       DECIMAL(8, 2) DEFAULT 100,
  CREDIT_LIMIT  DECIMAL(8, 2),
  REP_NUM       CHAR(2),
  CONSTRAINT ck_Balance CHECK (BALANCE >= 0 AND BALANCE <= CREDIT_LIMIT)
);

CREATE TABLE ORDERS (
  ORDER_NUM    CHAR(5) PRIMARY KEY,
  ORDER_DATE   DATE,
  CUSTOMER_NUM CHAR(3)
);

CREATE TABLE PART (
  PART_NUM    CHAR(4) PRIMARY KEY,
  DESCRIPTION CHAR(15),
  ON_HAND     DECIMAL(4, 0),
  CLASS       CLASSES,
  WAREHOUSE   CHAR(1),
  PRICE       DECIMAL(6, 2)
);

CREATE TABLE ORDER_LINE (
  ORDER_NUM    CHAR(5) NOT NULL,
  PART_NUM     CHAR(4) NOT NULL,
  NUM_ORDERED  DECIMAL(3, 0),
  QUOTED_PRICE DECIMAL(6, 2),
  PRIMARY KEY (ORDER_NUM, PART_NUM),
  CONSTRAINT ck_ORDER_NUMBER CHECK(char_length(ORDER_NUM) > 0),
  CONSTRAINT ck_PART_NUMBER CHECK(char_length(PART_NUM) > 0)
);


INSERT INTO REP
VALUES ('20', 'Kaiser', 'Valerie', '624 Randall', 'Grove', 'ONT', '33321', 20542.50, 0.05);

INSERT INTO REP
VALUES ('35', 'Hull', 'Richard', '532 Jackson', 'Sheldon', 'ONT', '33553', 39216.00, 0.07);

INSERT INTO REP
VALUES ('65', 'Perez', 'Juan', '1626 Taylor', 'Fillmore', 'ONT', '33336', 23487.00, 0.05);

INSERT INTO CUSTOMER
VALUES('148', 'Al''s Appliance and Sport', '2837 Greenway', 'Fillmore', 'ONT', '33336', 6550.00, 7500.00, '20');

INSERT INTO CUSTOMER
VALUES ('282', 'Brookings Direct', '3827 Devon', 'Grove', 'ONT', '33321', 431.50, 10000.00, '35');

INSERT INTO CUSTOMER
VALUES ('356', 'Ferguson''s', '382 Wildwood', 'Northfield', 'ONT', '33146', 5785.00, 7500.00, '65');

INSERT INTO CUSTOMER
VALUES ('408', 'The Everything Shop', '1828 Raven', 'Crystal', 'ONT', '33503', 5000.00, 5000.00, '35');

INSERT INTO CUSTOMER
VALUES ('689', 'The Everything Shoppe', '181 Black', 'Ottawa', 'ONT', '33403', 5000.00, 5000.00, '20');

INSERT INTO CUSTOMER
VALUES ('462', 'Bargain Galores', '30 West', 'Ottawa', 'ONT', '33321', 35612.00, 40000.00, '20');

INSERT INTO CUSTOMER
VALUES ('463', 'Bargains Galore', '3829 Central', 'Grove', 'ONT', '33321', 3412.00, 10000.00, '65');

INSERT INTO CUSTOMER
VALUES ('524', 'Kline''s', '838 Ridgeland', 'Fillmore', 'ONT', '33336', 12762.00, 15000.00, '20');

INSERT INTO CUSTOMER
VALUES ('608', 'Johnson''s Department Store', '372 Oxford', 'Sheldon', 'ONT', '33553', 2106.00, 10000.00, '65');

INSERT INTO CUSTOMER
VALUES ('687', 'Lee''s Sport and Appliance', '282 Evergreen', 'Altonville', 'ONT', '32543', 2851.00, 5000.00, '35');

INSERT INTO CUSTOMER
VALUES ('725', 'Deerfield''s Four Seasons', '282 Columbia', 'Sheldon', 'ONT', '33553', 248.00, 7500.00, '35');

INSERT INTO CUSTOMER
VALUES ('842', 'All Season', '28 Lakeview', 'Grove', 'ONT', '33321', 7500.00, 7500.00, '20');

INSERT INTO ORDERS
VALUES ('21608', '2007-10-20', '148');

INSERT INTO ORDERS
VALUES ('21610', '2007-10-20', '356');

INSERT INTO ORDERS
VALUES ('21613', '2007-10-21', '408');

INSERT INTO ORDERS
VALUES ('21614', '2007-10-21', '282');

INSERT INTO ORDERS
VALUES ('21617', '2007-10-23', '608');

INSERT INTO ORDERS
VALUES ('21619', '2007-10-23', '148');

INSERT INTO ORDERS
VALUES ('21623', '2007-10-23', '608');

INSERT INTO PART
VALUES ('AT94', 'Iron', 50, 'HW', '3', 24.95);

INSERT INTO PART
VALUES ('BV06', 'Home Gym', 45, 'SG', '2', 794.95);

INSERT INTO PART
VALUES ('CD52', 'Microwave Oven', 32, 'AP', '1', 165.00);

INSERT INTO PART
VALUES ('DL71', 'Cordless Drill', 21, 'HW', '3', 129.95);

INSERT INTO PART
VALUES ('DR93', 'Gas Range', 8, 'AP', '2', 495.00);

INSERT INTO PART
VALUES ('DW11', 'Washer', 12, 'AP', '3', 399.99);

INSERT INTO PART
VALUES ('FD21', 'Stand Mixer', 22, 'HW', '3', 159.95);

INSERT INTO PART
VALUES ('KL62', 'Dryer', 12, 'AP', '1', 349.95);

INSERT INTO PART
VALUES ('KT03', 'Dishwasher', 8, 'AP', '3', 595.00);

INSERT INTO PART
VALUES ('KV29', 'Treadmill', 9, 'SG', '2', 1390.00);

INSERT INTO ORDER_LINE
VALUES ('21608', 'AT94', 11, 21.95);

INSERT INTO ORDER_LINE
VALUES ('21610', 'DR93', 1, 495.00);

INSERT INTO ORDER_LINE
VALUES ('21610', 'DW11', 1, 399.99);

INSERT INTO ORDER_LINE
VALUES ('21613', 'KL62', 4, 329.95);

INSERT INTO ORDER_LINE
VALUES ('21614', 'KT03', 2, 595.00);

INSERT INTO ORDER_LINE
VALUES ('21617', 'BV06', 2, 794.95);

INSERT INTO ORDER_LINE
VALUES ('21617', 'CD52', 4, 150.00);

INSERT INTO ORDER_LINE
VALUES ('21619', 'DR93', 1, 495.00);

INSERT INTO ORDER_LINE
VALUES ('21623', 'KV29', 2, 1290.00);


-- 2 --

SELECT CUSTOMER_NUM, CUSTOMER_NAME
FROM CUSTOMER
WHERE REP_NUM <> '20';

-- 3 --

SELECT R.REP_NUM,
      (R.FIRST_NAME || ' ' || R.LAST_NAME) AS NAME,
      (
        SELECT count(*)
        FROM CUSTOMER
        WHERE REP_NUM = R.REP_NUM
      ) AS Customer_Count
FROM REP R;

-- 4 --

SELECT CUSTOMER_NUM, CUSTOMER_NAME, BALANCE, REP_NUM
FROM CUSTOMER
WHERE BALANCE > (
  SELECT MIN(balance)
  FROM CUSTOMER
  WHERE REP_NUM = '65'
);

-- 5 --

SELECT O.ORDER_NUM, O.ORDER_DATE
FROM ORDERS O
  INNER JOIN ORDER_LINE OL ON OL.ORDER_NUM = O.ORDER_NUM
  INNER JOIN PART P ON P.PART_NUM = OL.PART_NUM
  INNER JOIN CUSTOMER C ON C.CUSTOMER_NUM = O.CUSTOMER_NUM
WHERE
  C.REP_NUM = '65' AND
  P.DESCRIPTION = 'Gas Range';

-- 6 --

SELECT CUSTOMER_NUM, CUSTOMER_NAME, BALANCE
FROM CUSTOMER
WHERE CREDIT_LIMIT = (
  SELECT MAX(CREDIT_LIMIT)
  FROM CUSTOMER
  WHERE REP_NUM = '35'
);Â 

-- 7 --

SELECT R.REP_NUM,
      (R.FIRST_NAME || ' ' || R.LAST_NAME) AS NAME,
      (
        SELECT sum(P.PRICE)
        FROM ORDERS O
          INNER JOIN ORDER_LINE OL ON OL.ORDER_NUM = O.ORDER_NUM
          INNER JOIN PART P ON P.PART_NUM = OL.PART_NUM
          INNER JOIN CUSTOMER C ON C.CUSTOMER_NUM = O.CUSTOMER_NUM
        WHERE P.CLASS = 'AP' AND C.REP_NUM = R.REP_NUM
      ) AS Total_Sales
FROM REP R;

-- 8 --

SELECT CREDIT_LIMIT,
  (
    SELECT COUNT(*)
    FROM CUSTOMER
    WHERE CREDIT_LIMIT = c.CREDIT_LIMIT AND
      REP_NUM = '35'
  ) AS Richard_Hull_Count
FROM CUSTOMER c
WHERE (
    SELECT COUNT(*)
    FROM CUSTOMER
    WHERE CREDIT_LIMIT = c.CREDIT_LIMIT
) < 2;

-- 9 --

SELECT P.DESCRIPTION
FROM PART P
  INNER JOIN ORDER_LINE OL ON OL.PART_NUM = P.PART_NUM
  INNER JOIN ORDERS O ON O.ORDER_NUM = OL.ORDER_NUM
WHERE O.ORDER_NUM = '21610';

-- 10 --

SELECT CUSTOMER_NUM, CUSTOMER_NAME, BALANCE, REP_NUM
FROM CUSTOMER
WHERE BALANCE > CREDIT_LIMIT * 0.85;

-- 11 --

SELECT CUSTOMER_NUM, CUSTOMER_NAME
FROM CUSTOMER
WHERE REP_NUM = '20' AND
  CUSTOMER_NUM NOT IN (
                        SELECT CUSTOMER_NUM
                        FROM ORDERS
                      );

-- 12 --

DELETE FROM ORDER_LINE WHERE ORDER_NUM IN (
  SELECT ORDER_NUM
  FROM ORDERS
  WHERE CUSTOMER_NUM = '408'
);
DELETE FROM ORDERS WHERE CUSTOMER_NUM = '408';
DELETE FROM CUSTOMER WHERE CUSTOMER_NUM = '408';